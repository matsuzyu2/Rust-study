# Chapter 08: éåŒæœŸå‡¦ç†

> **ã“ã®ç« ã§å­¦ã¶ã“ã¨**: async/awaitã€Futureã€tokioãƒ©ãƒ³ã‚¿ã‚¤ãƒ  â€” Rustã§ã®éåŒæœŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ä»•çµ„ã¿ã¨å®Ÿè·µ

> ğŸ“– **è¨˜å·ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹**: ã“ã®ç« ã§ã¯ `async`, `await`, `move`, `'static` ãªã©å¤šãã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒç™»å ´ã—ã¾ã™ã€‚æ„å‘³ãŒã‚ã‹ã‚‰ãªããªã£ãŸã‚‰ [Chapter 11: è¨˜å·ãƒ»æ§‹æ–‡ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](11-syntax-reference.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

## ãªãœéåŒæœŸå‡¦ç†ãŒå¿…è¦ã‹

Webé–‹ç™ºã§ã¯ã€I/Oå¾…ã¡ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰ãŒé »ç¹ã«ç™ºç”Ÿã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå‡¦ç†ã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```
1. APIã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ï¼ˆ100msï¼‰
2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ï¼ˆ50msï¼‰
3. åˆ¥ã®APIã«é€šçŸ¥ï¼ˆ80msï¼‰
```

**åŒæœŸå‡¦ç†ã®å ´åˆ**ï¼š
```
æ™‚é–“ â†’
[APIãƒªã‚¯ã‚¨ã‚¹ãƒˆå¾…ã¡ 100ms][DBå¾…ã¡ 50ms][APIé€šçŸ¥å¾…ã¡ 80ms]
åˆè¨ˆ: 230msã€ã“ã®é–“ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ä½•ã‚‚ã›ãšå¾…æ©Ÿ
```

**éåŒæœŸå‡¦ç†ã®å ´åˆ**ï¼š
```
æ™‚é–“ â†’
[APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ]  [DB]  [APIé€šçŸ¥]
    â†“å¾…ã¡æ™‚é–“ä¸­ã«ä»–ã®å‡¦ç†ãŒå¯èƒ½
åˆè¨ˆ: å¾…ã¡æ™‚é–“ã‚’æœ‰åŠ¹æ´»ç”¨
```

### 3ã¤ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®æ¯”è¼ƒ

| ãƒ¢ãƒ‡ãƒ« | èª¬æ˜ | ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ | ä¾‹ |
|-------|------|-------------|-----|
| åŒæœŸï¼ˆãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰ | å‡¦ç†å®Œäº†ã¾ã§å¾…ã¤ | åŠ¹ç‡çš„ | å¾“æ¥ã®Python |
| ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ | å„æ¥ç¶šã«ã‚¹ãƒ¬ãƒƒãƒ‰ | é«˜ã„ï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰æ¯ã«MBå˜ä½ï¼‰ | Javaã€Go |
| éåŒæœŸï¼ˆãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰ | å¾…ã¡æ™‚é–“ã«ä»–ã®å‡¦ç† | ä½ã„ï¼ˆã‚¿ã‚¹ã‚¯æ¯ã«KBå˜ä½ï¼‰ | Node.jsã€Python asyncioã€Rust |

Rustã®éåŒæœŸå‡¦ç†ã¯ã€**å°‘ãªã„ãƒ¡ãƒ¢ãƒªã§å¤§é‡ã®ä¸¦è¡Œå‡¦ç†**ã‚’å®Ÿç¾ã—ã¾ã™ã€‚1ä¸‡æ¥ç¶šã‚’å‡¦ç†ã™ã‚‹å ´åˆã€ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ¢ãƒ‡ãƒ«ã§ã¯æ•°GBã®ãƒ¡ãƒ¢ãƒªãŒå¿…è¦ã§ã™ãŒã€éåŒæœŸãƒ¢ãƒ‡ãƒ«ã§ã¯æ•°åMBã§æ¸ˆã¿ã¾ã™ã€‚

---

## async/await ã®åŸºæœ¬

ã¾ãšã¯æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªä¾‹ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ã€‚

```rust
async fn hello() -> String {
    String::from("Hello, async world!")
}

#[tokio::main]
async fn main() {
    let result = hello().await;
    println!("{}", result);
}
```

### ã‚³ãƒ¼ãƒ‰ã‚’è¡Œã”ã¨ã«èª­ã¿è§£ã

```rust
async fn hello() -> String {
```
- `async fn` = éåŒæœŸé–¢æ•°ã‚’å®šç¾©
- ã“ã®é–¢æ•°ã¯`String`ã‚’è¿”ã™ã‚ˆã†ã«è¦‹ãˆã‚‹ãŒã€å®Ÿéš›ã«ã¯`Future<Output = String>`ã‚’è¿”ã™

```rust
#[tokio::main]
async fn main() {
```
- `#[tokio::main]` = tokioãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’èµ·å‹•ã™ã‚‹ãƒã‚¯ãƒ­
- `main`é–¢æ•°ã‚’éåŒæœŸã«ã—ã¦ã„ã‚‹

```rust
let result = hello().await;
```
- `.await` = Futureã®å®Œäº†ã‚’å¾…ã¤
- **é‡è¦**: `.await`ã¯å¾Œç½®æ¼”ç®—å­ï¼ˆ`await hello()`ã§ã¯ãªã`hello().await`ï¼‰

### ãªãœ`.await`ã¯å¾Œç½®ãªã®ã‹ï¼Ÿ

ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ã§ä½¿ã„ã‚„ã™ãã™ã‚‹ãŸã‚ã§ã™ï¼š

```rust
// Rustã®å¾Œç½®.await â€” èª­ã¿ã‚„ã™ã„
let data = fetch_user()
    .await?
    .parse_json()
    .await?
    .validate()?;

// ã‚‚ã—å‰ç½®ã ã£ãŸã‚‰ â€” ãƒã‚¹ãƒˆãŒæ·±ããªã‚‹
let data = validate(await parse_json(await fetch_user())?)?;
```

ğŸ”„ **æ¯”è¼ƒï¼ˆJavaScriptï¼‰**:
```javascript
async function hello() {
    return "Hello, async world!";
}

async function main() {
    const result = await hello();
    console.log(result);
}
```

ğŸ”„ **æ¯”è¼ƒï¼ˆPythonï¼‰**:
```python
import asyncio

async def hello():
    return "Hello, async world!"

async def main():
    result = await hello()
    print(result)

asyncio.run(main())
```

---

## Future â€” Rustã®éåŒæœŸã®ä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹

ã“ã“ã‹ã‚‰ãŒ**ä»–ã®è¨€èªã¨ã®æœ€å¤§ã®é•ã„**ã§ã™ã€‚Rustã®éåŒæœŸã‚’æ­£ã—ãç†è§£ã™ã‚‹ãŸã‚ã«ã€Futureã®ä»•çµ„ã¿ã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚

### Futureã¨ã¯ä½•ã‹

`async fn`ã¯å®Ÿéš›ã«ã¯**Futureã‚’è¿”ã™é–¢æ•°**ã§ã™ã€‚

```rust
use std::future::Future;

// ã“ã®2ã¤ã¯åŒç­‰
async fn hello() -> String {
    String::from("Hello")
}

fn hello_explicit() -> impl Future<Output = String> {
    async {
        String::from("Hello")
    }
}
```

**`impl Future<Output = String>`ã®èª­ã¿æ–¹**:
- `impl Future` = Futureãƒˆãƒ¬ã‚¤ãƒˆã‚’å®Ÿè£…ã—ãŸä½•ã‚‰ã‹ã®å‹
- `Output = String` = ã“ã®FutureãŒå®Œäº†ã™ã‚‹ã¨`String`ã‚’è¿”ã™

### ğŸš¨ æœ€é‡è¦: Futureã¯é…å»¶è©•ä¾¡ï¼ˆLazyï¼‰

**ã“ã‚ŒãŒJavaScript/Pythonã¨ã®æœ€å¤§ã®é•ã„ã§ã™ã€‚**

```rust
async fn expensive_computation() -> i32 {
    println!("è¨ˆç®—é–‹å§‹!");  // awaitã•ã‚Œã‚‹ã¾ã§å®Ÿè¡Œã•ã‚Œãªã„ï¼
    42
}

#[tokio::main]
async fn main() {
    let future = expensive_computation();  // â† ã“ã“ã§ã¯ä½•ã‚‚å®Ÿè¡Œã•ã‚Œãªã„
    println!("Futureã‚’ä½œæˆ");
    
    let result = future.await;  // â† ã“ã“ã§åˆã‚ã¦ã€Œè¨ˆç®—é–‹å§‹!ã€ãŒå‡ºåŠ›ã•ã‚Œã‚‹
    println!("çµæœ: {}", result);
}
```

**å‡ºåŠ›**:
```
Futureã‚’ä½œæˆ
è¨ˆç®—é–‹å§‹!
çµæœ: 42
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  JavaScript/Python vs Rust ã®éåŒæœŸ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  JavaScript:                                                    â”‚
â”‚    const promise = fetchData();  // å³åº§ã«å®Ÿè¡Œé–‹å§‹               â”‚
â”‚    await promise;                // å®Œäº†ã‚’å¾…ã¤ã ã‘               â”‚
â”‚                                                                 â”‚
â”‚  Python:                                                        â”‚
â”‚    coro = fetch_data()           # ã‚³ãƒ«ãƒ¼ãƒãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ     â”‚
â”‚    await coro                    # å®Ÿè¡Œé–‹å§‹ï¼‹å®Œäº†å¾…ã¡            â”‚
â”‚    # â€»awaitã™ã‚‹ã¾ã§å®Ÿè¡Œã•ã‚Œãªã„ãŒã€è¨­è¨ˆæ€æƒ³ãŒç•°ãªã‚‹              â”‚
â”‚                                                                 â”‚
â”‚  Rust:                                                          â”‚
â”‚    let future = fetch_data();    // Futureã‚’ä½œæˆï¼ˆä½•ã‚‚å®Ÿè¡Œã—ãªã„ï¼‰â”‚
â”‚    future.await;                 // å®Ÿè¡Œé–‹å§‹ï¼‹å®Œäº†å¾…ã¡            â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Rustã®è¨­è¨ˆç†ç”±:                                                 â”‚
â”‚  1. ã‚¼ãƒ­ã‚³ã‚¹ãƒˆæŠ½è±¡åŒ– â€” ä½¿ã‚ãªã„ã‚‚ã®ã«ã‚³ã‚¹ãƒˆã‚’æ‰•ã‚ãªã„             â”‚
â”‚  2. æ˜ç¤ºçš„ãªåˆ¶å¾¡ â€” ã„ã¤å®Ÿè¡Œã™ã‚‹ã‹ã‚’å®Œå…¨ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«             â”‚
â”‚  3. ã‚­ãƒ£ãƒ³ã‚»ãƒ« â€” awaitã—ãªã‘ã‚Œã°ãƒªã‚½ãƒ¼ã‚¹ã‚’æ¶ˆè²»ã—ãªã„              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Futureãƒˆãƒ¬ã‚¤ãƒˆã®ä¸­èº«ï¼ˆæ¦‚å¿µç†è§£ï¼‰

FutureãŒã©ã†å‹•ãã‹ã€æ¦‚å¿µãƒ¬ãƒ™ãƒ«ã§ç†è§£ã—ã¾ã—ã‚‡ã†ã€‚

```rust
// æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã®å®šç¾©ï¼ˆç°¡ç•¥åŒ–ï¼‰
trait Future {
    type Output;
    
    fn poll(self: Pin<&mut Self>, cx: &mut Context<'_>) -> Poll<Self::Output>;
}

enum Poll<T> {
    Ready(T),    // å®Œäº†ã€çµæœã¯T
    Pending,     // ã¾ã å®Œäº†ã—ã¦ã„ãªã„
}
```

**`poll`ãƒ¡ã‚½ãƒƒãƒ‰ã®å‹•ä½œ**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Future ã®å®Ÿè¡Œãƒ¢ãƒ‡ãƒ«                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ï¼ˆtokioï¼‰ãŒFutureã®poll()ã‚’å‘¼ã¶                    â”‚
â”‚                                                                 â”‚
â”‚  2. Futureã¯å‡¦ç†ã‚’é€²ã‚ã‚‹                                         â”‚
â”‚     - I/Oå¾…ã¡ã«ãªã£ãŸã‚‰ â†’ Poll::Pending ã‚’è¿”ã™                   â”‚
â”‚     - å®Œäº†ã—ãŸã‚‰ â†’ Poll::Ready(çµæœ) ã‚’è¿”ã™                      â”‚
â”‚                                                                 â”‚
â”‚  3. Pendingã®å ´åˆã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¯ä»–ã®Futureã‚’å®Ÿè¡Œ                   â”‚
â”‚                                                                 â”‚
â”‚  4. I/OãŒå®Œäº†ã™ã‚‹ã¨ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã«é€šçŸ¥ï¼ˆWakerï¼‰                    â”‚
â”‚                                                                 â”‚
â”‚  5. ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¯å†åº¦poll()ã‚’å‘¼ã¶                                 â”‚
â”‚                                                                 â”‚
â”‚  ã“ã‚Œã‚’ã€Œå”èª¿çš„ãƒãƒ«ãƒã‚¿ã‚¹ã‚¯ã€ã¨å‘¼ã¶                               â”‚
â”‚  ï¼ˆFutureãŒè‡ªç™ºçš„ã«åˆ¶å¾¡ã‚’è¿”ã™ï¼‰                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ãªãœã“ã‚Œã‚’çŸ¥ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã‹ï¼Ÿ**

1. ãƒ‡ãƒãƒƒã‚°æ™‚ã«ã€Œãªãœå®Ÿè¡Œã•ã‚Œãªã„ã®ã‹ã€ã‚’ç†è§£ã§ãã‚‹
2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã®åŸºç¤çŸ¥è­˜ã«ãªã‚‹
3. `Pin`ã‚„ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ ã®ç†è§£ã«ã¤ãªãŒã‚‹

---

## tokio ãƒ©ãƒ³ã‚¿ã‚¤ãƒ 

Rustã®`async/await`ã¯**ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ï¼ˆå®Ÿè¡Œç’°å¢ƒï¼‰ãŒå¿…è¦**ã§ã™ã€‚æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¯å«ã¾ã‚Œãšã€å¤–éƒ¨ã‚¯ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã„ã¾ã™ã€‚

### ãªãœãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãŒæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ãªã„ã®ã‹ï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Rustã®è¨­è¨ˆå“²å­¦                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ã€Œã‚¼ãƒ­ã‚³ã‚¹ãƒˆæŠ½è±¡åŒ–ã€ã¨ã€Œé¸æŠã®è‡ªç”±ã€                             â”‚
â”‚                                                                 â”‚
â”‚  - éåŒæœŸã‚’ä½¿ã‚ãªã„ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®ã‚³ã‚¹ãƒˆã‚’å¼·åˆ¶ã—ãªã„      â”‚
â”‚  - ç”¨é€”ã«å¿œã˜ã¦æœ€é©ãªãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’é¸ã¹ã‚‹                          â”‚
â”‚                                                                 â”‚
â”‚  ä¸»ãªãƒ©ãƒ³ã‚¿ã‚¤ãƒ :                                                 â”‚
â”‚  - tokio: æœ€ã‚‚äººæ°—ã€‚æ±ç”¨çš„ã€‚                                     â”‚
â”‚  - async-std: æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«è¿‘ã„APIã€‚                          â”‚
â”‚  - smol: è»½é‡ã€‚çµ„ã¿è¾¼ã¿å‘ã‘ã€‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### tokioã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```toml
# Cargo.toml
[dependencies]
tokio = { version = "1", features = ["full"] }
```

**features ã®èª¬æ˜**:
- `"full"` = å…¨æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ï¼ˆé–‹ç™ºæ™‚ã«ä¾¿åˆ©ï¼‰
- æœ¬ç•ªã§ã¯å¿…è¦ãªæ©Ÿèƒ½ã ã‘é¸ã¶: `["rt-multi-thread", "net", "time"]`

### åŸºæœ¬çš„ãªä½¿ã„æ–¹

```rust
use tokio::time::{sleep, Duration};

#[tokio::main]  // ã“ã®ãƒã‚¯ãƒ­ãŒãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’èµ·å‹•
async fn main() {
    println!("é–‹å§‹");
    sleep(Duration::from_secs(1)).await;
    println!("1ç§’å¾Œ");
}
```

### `#[tokio::main]`ã®è£å´

ã“ã®ãƒã‚¯ãƒ­ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å±•é–‹ã•ã‚Œã¾ã™ï¼š

```rust
// #[tokio::main]
// async fn main() { ... }

// â†“ å±•é–‹å¾Œ

fn main() {
    tokio::runtime::Builder::new_multi_thread()
        .enable_all()
        .build()
        .unwrap()
        .block_on(async {
            // ã“ã“ã«async fn main()ã®ä¸­èº«
        })
}
```

ã“ã‚Œã‚’çŸ¥ã£ã¦ãŠãã¨ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒã§ãã¾ã™ï¼š

```rust
// ã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ï¼ˆè»½é‡ï¼‰
#[tokio::main(flavor = "current_thread")]
async fn main() { ... }

// ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã‚’æŒ‡å®š
#[tokio::main(worker_threads = 4)]
async fn main() { ... }
```

---

## ä¸¦è¡Œå®Ÿè¡Œ

### join! â€” è¤‡æ•°ã®Futureã‚’åŒæ™‚å®Ÿè¡Œ

```rust
use tokio::time::{sleep, Duration};

async fn task1() -> String {
    println!("Task1: é–‹å§‹");
    sleep(Duration::from_secs(1)).await;
    println!("Task1: å®Œäº†");
    String::from("Task 1 ã®çµæœ")
}

async fn task2() -> String {
    println!("Task2: é–‹å§‹");
    sleep(Duration::from_secs(2)).await;
    println!("Task2: å®Œäº†");
    String::from("Task 2 ã®çµæœ")
}

#[tokio::main]
async fn main() {
    // ä¸¦è¡Œå®Ÿè¡Œï¼ˆåˆè¨ˆ2ç§’ã§å®Œäº†ï¼‰
    let (result1, result2) = tokio::join!(task1(), task2());
    
    println!("{}", result1);
    println!("{}", result2);
}
```

**å‡ºåŠ›**:
```
Task1: é–‹å§‹
Task2: é–‹å§‹
Task1: å®Œäº†    â† 1ç§’å¾Œ
Task2: å®Œäº†    â† 2ç§’å¾Œï¼ˆtask1ã¨ä¸¦è¡Œã—ã¦é€²ã‚“ã§ã„ãŸï¼‰
Task 1 ã®çµæœ
Task 2 ã®çµæœ
```

**é‡è¦**: `join!`ã¯**ä¸¦è¡Œï¼ˆconcurrentï¼‰**ã§ã‚ã£ã¦**ä¸¦åˆ—ï¼ˆparallelï¼‰**ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸¦è¡Œ vs ä¸¦åˆ—                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ä¸¦è¡Œï¼ˆConcurrentï¼‰:                                             â”‚
â”‚    1ã¤ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§è¤‡æ•°ã®ã‚¿ã‚¹ã‚¯ã‚’äº¤äº’ã«å®Ÿè¡Œ                        â”‚
â”‚    ã‚¿ã‚¹ã‚¯A â†’ I/Oå¾…ã¡ â†’ ã‚¿ã‚¹ã‚¯B â†’ I/Oå¾…ã¡ â†’ ã‚¿ã‚¹ã‚¯A...            â”‚
â”‚                                                                 â”‚
â”‚  ä¸¦åˆ—ï¼ˆParallelï¼‰:                                               â”‚
â”‚    è¤‡æ•°ã®ã‚¹ãƒ¬ãƒƒãƒ‰/CPUã§åŒæ™‚ã«å®Ÿè¡Œ                                 â”‚
â”‚    ã‚¹ãƒ¬ãƒƒãƒ‰1: ã‚¿ã‚¹ã‚¯A                                            â”‚
â”‚    ã‚¹ãƒ¬ãƒƒãƒ‰2: ã‚¿ã‚¹ã‚¯B                                            â”‚
â”‚                                                                 â”‚
â”‚  tokio::join! â†’ ä¸¦è¡Œ                                            â”‚
â”‚  tokio::spawn â†’ ä¸¦åˆ—ã‚‚å¯èƒ½ï¼ˆãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®å ´åˆï¼‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ğŸ”„ **æ¯”è¼ƒï¼ˆJavaScriptï¼‰**:
```javascript
const [result1, result2] = await Promise.all([task1(), task2()]);
```

ğŸ”„ **æ¯”è¼ƒï¼ˆPythonï¼‰**:
```python
result1, result2 = await asyncio.gather(task1(), task2())
```

### select! â€” æœ€åˆã«å®Œäº†ã—ãŸã‚‚ã®ã‚’å–å¾—

ã€Œã©ã¡ã‚‰ã‹æ—©ã„æ–¹ã€ã‚’å¾…ã¡ãŸã„å ´åˆã«ä½¿ã„ã¾ã™ã€‚

```rust
use tokio::time::{sleep, Duration};

#[tokio::main]
async fn main() {
    tokio::select! {
        _ = sleep(Duration::from_secs(1)) => {
            println!("1ç§’çµŒé");
        }
        _ = sleep(Duration::from_secs(2)) => {
            println!("2ç§’çµŒé");  // ã“ã‚Œã¯å®Ÿè¡Œã•ã‚Œãªã„
        }
    }
}
```

**å…¸å‹çš„ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**

```rust
use tokio::time::{sleep, Duration, timeout};

async fn slow_operation() -> String {
    sleep(Duration::from_secs(10)).await;
    String::from("å®Œäº†")
}

#[tokio::main]
async fn main() {
    // 5ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    match timeout(Duration::from_secs(5), slow_operation()).await {
        Ok(result) => println!("æˆåŠŸ: {}", result),
        Err(_) => println!("ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼"),
    }
}
```

---

## spawn â€” ã‚¿ã‚¹ã‚¯ã®ç”Ÿæˆ

`tokio::spawn`ã¯**åˆ¥ã‚¿ã‚¹ã‚¯ã¨ã—ã¦ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ**ã—ã¾ã™ã€‚

```rust
use tokio::time::{sleep, Duration};

#[tokio::main]
async fn main() {
    // ã‚¿ã‚¹ã‚¯ã‚’spawnï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œé–‹å§‹ï¼‰
    let handle = tokio::spawn(async {
        sleep(Duration::from_secs(1)).await;
        42
    });
    
    println!("ã‚¿ã‚¹ã‚¯ã‚’ç”Ÿæˆã—ã¾ã—ãŸ");
    
    // ä»–ã®å‡¦ç†ã‚’ã—ã¦ã„ã‚‹é–“ã‚‚ã‚¿ã‚¹ã‚¯ã¯é€²è¡Œä¸­
    
    // çµæœã‚’å¾…ã¤
    let result = handle.await.unwrap();
    println!("çµæœ: {}", result);
}
```

### `join!`ã¨`spawn`ã®é•ã„

```rust
// join! â€” ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯å†…ã§ä¸¦è¡Œå®Ÿè¡Œ
tokio::join!(task1(), task2());

// spawn â€” åˆ¥ã‚¿ã‚¹ã‚¯ã¨ã—ã¦å®Ÿè¡Œï¼ˆãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ãªã‚‰åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§ï¼‰
let h1 = tokio::spawn(task1());
let h2 = tokio::spawn(task2());
h1.await.unwrap();
h2.await.unwrap();
```

### ğŸš¨ spawnã«å¿…è¦ãªåˆ¶ç´„: `Send + 'static`

`tokio::spawn`ã«æ¸¡ã™Futureã«ã¯**ç‰¹åˆ¥ãªåˆ¶ç´„**ãŒã‚ã‚Šã¾ã™ã€‚

```rust
// âŒ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ï¼
fn bad_spawn() {
    let data = String::from("hello");
    
    tokio::spawn(async {
        println!("{}", data);  // dataã‚’å€Ÿç”¨
    });  // ã‚¨ãƒ©ãƒ¼: `data`ã¯ã“ã®ã‚¹ã‚³ãƒ¼ãƒ—ã§ç ´æ£„ã•ã‚Œã‚‹ãŒã€ã‚¿ã‚¹ã‚¯ã¯ã¾ã ä½¿ãŠã†ã¨ã—ã¦ã„ã‚‹
}

// âœ… move ã§æ‰€æœ‰æ¨©ã‚’ç§»å‹•
fn good_spawn() {
    let data = String::from("hello");
    
    tokio::spawn(async move {  // move ã‚’è¿½åŠ 
        println!("{}", data);  // dataã®æ‰€æœ‰æ¨©ã‚’æŒã£ã¦ã„ã‚‹
    });
}
```

**ãªãœ`move`ãŒå¿…è¦ãªã®ã‹ï¼Ÿ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  spawn ã¨ 'static å¢ƒç•Œ                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  tokio::spawn(future) ã® future ã«ã¯ä»¥ä¸‹ãŒè¦æ±‚ã•ã‚Œã‚‹ï¼š           â”‚
â”‚                                                                 â”‚
â”‚  1. Send â€” åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã«é€ã‚Œã‚‹                                    â”‚
â”‚     ï¼ˆãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã¯åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§ï¼‰   â”‚
â”‚                                                                 â”‚
â”‚  2. 'static â€” å‚ç…§ãŒãªã„ã€ã¾ãŸã¯'staticãªå‚ç…§ã®ã¿                 â”‚
â”‚     ï¼ˆã‚¿ã‚¹ã‚¯ãŒã„ã¤ã¾ã§ç”Ÿå­˜ã™ã‚‹ã‹ä¸æ˜ãªãŸã‚ï¼‰                      â”‚
â”‚                                                                 â”‚
â”‚  move ã‚’ä½¿ã†ã¨:                                                  â”‚
â”‚  - å¤‰æ•°ã®æ‰€æœ‰æ¨©ãŒã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã«ç§»å‹•                                 â”‚
â”‚  - ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã¯å¤–éƒ¨ã¸ã®å‚ç…§ã‚’æŒãŸãªããªã‚‹                         â”‚
â”‚  - 'static ã‚’æº€ãŸã›ã‚‹                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Sendã‚’æº€ãŸã•ãªã„ä¾‹**:

```rust
use std::rc::Rc;

// âŒ Rc ã¯ Send ã‚’å®Ÿè£…ã—ã¦ã„ãªã„
let data = Rc::new(42);
tokio::spawn(async move {
    println!("{}", data);  // ã‚¨ãƒ©ãƒ¼ï¼
});

// âœ… Arc ã¯ Send ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹
use std::sync::Arc;
let data = Arc::new(42);
tokio::spawn(async move {
    println!("{}", data);  // OK
});
```

---

## async move â€” ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã®æ‰€æœ‰æ¨©

`async move`ã¯é »å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚ã—ã£ã‹ã‚Šç†è§£ã—ã¾ã—ã‚‡ã†ã€‚

```rust
async fn process_data(data: String) {
    println!("å‡¦ç†: {}", data);
}

#[tokio::main]
async fn main() {
    let data = String::from("important data");
    
    // move ãªã— â€” data ã‚’å€Ÿç”¨
    let task1 = async {
        println!("{}", data);  // å€Ÿç”¨
    };
    
    // move ã‚ã‚Š â€” data ã®æ‰€æœ‰æ¨©ã‚’å¥ªã†
    let task2 = async move {
        println!("{}", data);  // æ‰€æœ‰
    };
    
    // task2 ã®å¾Œã€data ã¯ä½¿ãˆãªã„
    // println!("{}", data);  // âŒ ã‚¨ãƒ©ãƒ¼ï¼æ‰€æœ‰æ¨©ã¯task2ã«ç§»å‹•ã—ãŸ
}
```

### ã„ã¤`async move`ãŒå¿…è¦ã‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  async move ãŒå¿…è¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. tokio::spawn ã«æ¸¡ã™                                         â”‚
â”‚     tokio::spawn(async move { ... });                           â”‚
â”‚                                                                 â”‚
â”‚  2. Futureã‚’è¿”ã™é–¢æ•°                                            â”‚
â”‚     fn foo() -> impl Future { async move { ... } }             â”‚
â”‚                                                                 â”‚
â”‚  3. FutureãŒå…ƒã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚ˆã‚Šé•·ãç”Ÿå­˜                             â”‚
â”‚     let future = async move { ... };                            â”‚
â”‚     // å…ƒã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’æŠœã‘ãŸå¾Œã‚‚futureã‚’ä½¿ã„ãŸã„                   â”‚
â”‚                                                                 â”‚
â”‚  4. ãƒ«ãƒ¼ãƒ—å†…ã§spawn                                             â”‚
â”‚     for item in items {                                         â”‚
â”‚         tokio::spawn(async move { use(item) });                 â”‚
â”‚     }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## éåŒæœŸã¨ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ 

éåŒæœŸé–¢æ•°ã§å‚ç…§ã‚’æ‰±ã†å ´åˆã€ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ ãŒè¤‡é›‘ã«ãªã‚Šã¾ã™ã€‚

### ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³

```rust
// âŒ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ï¼
async fn bad_example(data: &String) {
    tokio::spawn(async {
        println!("{}", data);  // dataã¯å€Ÿç”¨ã ãŒã€spawnã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã®ç”Ÿå­˜æœŸé–“ã¯ä¸æ˜
    });
}
```

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**:
```
error[E0597]: `data` does not live long enough
```

### è§£æ±ºç­–1: ã‚¯ãƒ­ãƒ¼ãƒ³

```rust
async fn good_example(data: &String) {
    let owned_data = data.clone();  // ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦æ‰€æœ‰
    tokio::spawn(async move {
        println!("{}", owned_data);
    });
}
```

### è§£æ±ºç­–2: Arcã§å…±æœ‰

```rust
use std::sync::Arc;

async fn good_example(data: Arc<String>) {
    let data_clone = Arc::clone(&data);
    tokio::spawn(async move {
        println!("{}", data_clone);
    });
}
```

### è§£æ±ºç­–3: spawnã›ãšã«join!

```rust
async fn good_example(data: &String) {
    // spawnã§ã¯ãªãjoin!ãªã‚‰å€Ÿç”¨ã§OK
    tokio::join!(
        async { println!("1: {}", data) },
        async { println!("2: {}", data) }
    );
}
```

---

## éåŒæœŸI/O

### ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ

```rust
use tokio::fs;

#[tokio::main]
async fn main() -> std::io::Result<()> {
    // ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿
    fs::write("hello.txt", "Hello, Tokio!").await?;
    
    // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
    let content = fs::read_to_string("hello.txt").await?;
    println!("{}", content);
    
    Ok(())
}
```

### HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆreqwestã‚¯ãƒ¬ãƒ¼ãƒˆï¼‰

```toml
# Cargo.toml
[dependencies]
tokio = { version = "1", features = ["full"] }
reqwest = { version = "0.11", features = ["json"] }
serde = { version = "1.0", features = ["derive"] }
```

```rust
use serde::Deserialize;

#[derive(Debug, Deserialize)]
struct User {
    id: i32,
    name: String,
}

#[tokio::main]
async fn main() -> Result<(), reqwest::Error> {
    let user: User = reqwest::get("https://api.example.com/users/1")
        .await?          // ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†ã‚’å¾…ã¤
        .json()          // JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ï¼ˆã“ã‚Œã‚‚éåŒæœŸï¼‰
        .await?;
    
    println!("{:?}", user);
    Ok(())
}
```

**`?`ãŒ2å›ã‚ã‚‹ç†ç”±**:
1. æœ€åˆã®`?` â€” HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¨ãƒ©ãƒ¼ã‚’ä¼æ’­
2. 2ç•ªç›®ã®`?` â€” JSONãƒ‘ãƒ¼ã‚¹ã®ã‚¨ãƒ©ãƒ¼ã‚’ä¼æ’­

ğŸ”„ **æ¯”è¼ƒï¼ˆJavaScriptï¼‰**:
```javascript
const response = await fetch("https://api.example.com/users/1");
const user = await response.json();
```

---

## ãƒãƒ£ãƒãƒ« â€” ã‚¿ã‚¹ã‚¯é–“é€šä¿¡

### mpscï¼ˆå¤šå¯¾ä¸€ãƒãƒ£ãƒãƒ«ï¼‰

è¤‡æ•°ã®é€ä¿¡è€…ã‹ã‚‰1ã¤ã®å—ä¿¡è€…ã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Šã¾ã™ã€‚

```rust
use tokio::sync::mpsc;

#[tokio::main]
async fn main() {
    // ãƒãƒƒãƒ•ã‚¡ã‚µã‚¤ã‚º32ã®ãƒãƒ£ãƒãƒ«ã‚’ä½œæˆ
    let (tx, mut rx) = mpsc::channel(32);
    
    // é€ä¿¡å´ã‚¿ã‚¹ã‚¯
    let tx_clone = tx.clone();  // è¤‡æ•°ã®é€ä¿¡è€…ã‚’ä½œã‚Œã‚‹
    tokio::spawn(async move {
        for i in 0..5 {
            tx_clone.send(i).await.unwrap();
        }
    });
    
    // åˆ¥ã®é€ä¿¡è€…
    tokio::spawn(async move {
        for i in 100..105 {
            tx.send(i).await.unwrap();
        }
    });
    
    // å—ä¿¡å´ï¼ˆå…¨é€ä¿¡è€…ãŒdropã•ã‚Œã‚‹ã¨NoneãŒè¿”ã‚‹ï¼‰
    while let Some(value) = rx.recv().await {
        println!("å—ä¿¡: {}", value);
    }
}
```

**ãƒãƒ£ãƒãƒ«ã®ç¨®é¡**:

| ç¨®é¡ | ç”¨é€” | ç‰¹å¾´ |
|-----|------|------|
| `mpsc` | å¤šå¯¾ä¸€ | è¤‡æ•°ã®Producerã‹ã‚‰1ã¤ã®Consumerã¸ |
| `oneshot` | ä¸€å¯¾ä¸€ã€ä¸€å›é™ã‚Š | çµæœã‚’1å›ã ã‘è¿”ã™ |
| `broadcast` | ä¸€å¯¾å¤š | å…¨è³¼èª­è€…ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ |
| `watch` | ä¸€å¯¾å¤šã€æœ€æ–°å€¤ã®ã¿ | è¨­å®šå¤‰æ›´ã®é€šçŸ¥ãªã© |

---

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

éåŒæœŸé–¢æ•°ã§ã‚‚`Result`ã¨`?`ãŒä½¿ãˆã¾ã™ã€‚

```rust
use tokio::fs;
use anyhow::{Context, Result};

async fn read_config() -> Result<String> {
    let content = fs::read_to_string("config.toml")
        .await
        .context("è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“")?;
    Ok(content)
}

#[tokio::main]
async fn main() -> Result<()> {
    match read_config().await {
        Ok(config) => println!("Config: {}", config),
        Err(e) => eprintln!("Error: {:?}", e),
    }
    Ok(())
}
```

---

## åŒæœŸã‚³ãƒ¼ãƒ‰ã¨ã®é€£æº

### spawn_blocking â€” åŒæœŸã‚³ãƒ¼ãƒ‰ã‚’éåŒæœŸã‹ã‚‰å‘¼ã¶

CPUãƒã‚¦ãƒ³ãƒ‰ãªå‡¦ç†ï¼ˆé‡ã„è¨ˆç®—ï¼‰ã¯ã€éåŒæœŸã‚¿ã‚¹ã‚¯ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã—ã¾ã„ã¾ã™ã€‚
`spawn_blocking`ã§åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã«é€ƒãŒã—ã¾ã—ã‚‡ã†ã€‚

```rust
use tokio::task::spawn_blocking;

fn heavy_computation() -> i32 {
    // CPUãƒã‚¦ãƒ³ãƒ‰ãªåŒæœŸå‡¦ç†ï¼ˆã“ã“ã§sleepç­‰ã‚’ä½¿ã†ã¨asyncå…¨ä½“ãŒãƒ–ãƒ­ãƒƒã‚¯ï¼ï¼‰
    let mut sum = 0;
    for i in 0..1_000_000 {
        sum += i;
    }
    sum
}

#[tokio::main]
async fn main() {
    // åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œï¼ˆéåŒæœŸãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
    let result = spawn_blocking(|| heavy_computation()).await.unwrap();
    println!("çµæœ: {}", result);
}
```

**ã„ã¤spawn_blockingãŒå¿…è¦ã‹**:
- é‡ã„è¨ˆç®—å‡¦ç†
- åŒæœŸçš„ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†å ´åˆ
- `std::thread::sleep`ã‚’ä½¿ã†å ´åˆï¼ˆéåŒæœŸã§ã¯`tokio::time::sleep`ã‚’ä½¿ã†ï¼‰

---

<details>
<summary>ğŸ“š ä¸Šç´šè€…å‘ã‘: Pin ã¨ è‡ªå·±å‚ç…§æ§‹é€ ä½“</summary>

### ãªãœPinãŒå¿…è¦ãªã®ã‹

`async`ãƒ–ãƒ­ãƒƒã‚¯ã¯å†…éƒ¨ã§**è‡ªå·±å‚ç…§æ§‹é€ ä½“**ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

```rust
async fn example() {
    let data = vec![1, 2, 3];
    let reference = &data;  // dataã¸ã®å‚ç…§
    
    some_async_operation().await;  // â† ã“ã®é–“ã«æ§‹é€ ä½“ãŒãƒ¡ãƒ¢ãƒªä¸Šã§ç§»å‹•ã™ã‚‹ã¨...
    
    println!("{:?}", reference);  // referenceãŒç„¡åŠ¹ã«ãªã‚‹å¯èƒ½æ€§ï¼
}
```

`.await`ã‚’ã¾ãŸã„ã§å‚ç…§ã‚’ä¿æŒã™ã‚‹å ´åˆã€æ§‹é€ ä½“ãŒãƒ¡ãƒ¢ãƒªä¸Šã§ç§»å‹•ï¼ˆãƒ ãƒ¼ãƒ–ï¼‰ã™ã‚‹ã¨å‚ç…§ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚

`Pin`ã¯ã€Œã“ã®å€¤ã¯ãƒ¡ãƒ¢ãƒªä¸Šã§ç§»å‹•ã—ãªã„ã€ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹å‹ã§ã™ã€‚

```rust
use std::pin::Pin;

// poll ã®å®šç¾©
fn poll(self: Pin<&mut Self>, cx: &mut Context<'_>) -> Poll<Self::Output>;
//           ^^^^^^^^^^^^
//           Pin<&mut Self> = ã€Œã“ã®Futureã¯ç§»å‹•ã—ãªã„ã€ã¨ã„ã†ä¿è¨¼
```

é€šå¸¸ã®async/awaitä½¿ç”¨ã§ã¯`Pin`ã‚’æ„è­˜ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½œã‚‹å ´åˆã‚„ã€æ‰‹å‹•ã§Futureã‚’å®Ÿè£…ã™ã‚‹å ´åˆã«å¿…è¦ã«ãªã‚Šã¾ã™ã€‚

</details>

---

## å®Ÿè·µãƒ‘ã‚¿ãƒ¼ãƒ³: ä¸¦åˆ—APIå‘¼ã³å‡ºã—

è¤‡æ•°ã®APIã‚’ä¸¦åˆ—ã«å‘¼ã³å‡ºã™å®Ÿè·µçš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚

```rust
use reqwest::Client;
use serde::Deserialize;
use anyhow::Result;

#[derive(Debug, Deserialize)]
struct User {
    id: i32,
    name: String,
}

async fn fetch_user(client: &Client, id: i32) -> Result<User> {
    let url = format!("https://api.example.com/users/{}", id);
    let user = client.get(&url).send().await?.json().await?;
    Ok(user)
}

#[tokio::main]
async fn main() -> Result<()> {
    let client = Client::new();
    
    // è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä¸¦è¡Œå–å¾—
    let ids = vec![1, 2, 3, 4, 5];
    
    // å„IDã«å¯¾ã—ã¦Futureã‚’ä½œæˆ
    let futures: Vec<_> = ids.iter()
        .map(|&id| fetch_user(&client, id))
        .collect();
    
    // ã™ã¹ã¦ã®Futureã‚’ä¸¦è¡Œå®Ÿè¡Œ
    let results = futures::future::join_all(futures).await;
    
    for result in results {
        match result {
            Ok(user) => println!("{:?}", user),
            Err(e) => eprintln!("Error: {}", e),
        }
    }
    
    Ok(())
}
```

---

## ã¾ã¨ã‚

| æ¦‚å¿µ | JavaScript | Python | Rust |
|-----|------------|--------|------|
| éåŒæœŸé–¢æ•° | `async function` | `async def` | `async fn` |
| å¾…æ©Ÿ | `await` | `await` | `.await`ï¼ˆå¾Œç½®ï¼‰ |
| Promise/Future | Promise | Coroutine | Future |
| ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  | çµ„ã¿è¾¼ã¿ | asyncio | tokioï¼ˆå¤–éƒ¨ï¼‰ |
| ä¸¦è¡Œå®Ÿè¡Œ | `Promise.all` | `asyncio.gather` | `tokio::join!` |
| ãƒ¬ãƒ¼ã‚¹ | `Promise.race` | `asyncio.wait` | `tokio::select!` |
| é…å»¶è©•ä¾¡ | âŒï¼ˆå³æ™‚å®Ÿè¡Œï¼‰ | â–³ | âœ…ï¼ˆæ˜ç¤ºçš„ï¼‰ |

ğŸ¯ **ã“ã®ç« ã®ãƒã‚¤ãƒ³ãƒˆ**:
- **Futureã¯é…å»¶è©•ä¾¡** â€” `await`ã™ã‚‹ã¾ã§å®Ÿè¡Œã•ã‚Œãªã„
- **ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãŒå¿…è¦** â€” tokioãŒæœ€ã‚‚ãƒãƒ”ãƒ¥ãƒ©ãƒ¼
- **join!** = ä¸¦è¡Œå®Ÿè¡Œã€**select!** = ãƒ¬ãƒ¼ã‚¹
- **spawn** = ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯ï¼ˆ`Send + 'static`ãŒå¿…è¦ï¼‰
- **async move** = ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã«æ‰€æœ‰æ¨©ã‚’ç§»å‹•
- **ãƒãƒ£ãƒãƒ«** = ã‚¿ã‚¹ã‚¯é–“é€šä¿¡

---

## TypeScript/Pythonã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®ãŸã‚ã®ç§»è¡Œã‚³ãƒ©ãƒ 

### æœ€å¤§ã®é•ã„: é…å»¶è©•ä¾¡

```javascript
// JavaScript: fetchã‚’å‘¼ã‚“ã ç¬é–“ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹
const promise = fetch(url);  // â† ã“ã“ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹
await promise;               // â† å®Œäº†ã‚’å¾…ã¤ã ã‘
```

```rust
// Rust: awaitã™ã‚‹ã¾ã§ä½•ã‚‚èµ·ããªã„
let future = fetch(url);     // â† ä½•ã‚‚èµ·ããªã„
future.await;                // â† ã“ã“ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹ï¼†å®Œäº†å¾…ã¡
```

### GILãŒãªã„ = çœŸã®ä¸¦åˆ—

Pythonã«ã¯**GILï¼ˆGlobal Interpreter Lockï¼‰**ãŒã‚ã‚Šã€ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ã§ã‚‚CPUä¸¦åˆ—ã¯åŠ¹ãã¾ã›ã‚“ã€‚

```python
# Python: GILã®ãŸã‚ã€CPUãƒã‚¦ãƒ³ãƒ‰ãªå‡¦ç†ã¯1ã‚³ã‚¢ã—ã‹ä½¿ãˆãªã„
# asyncioã¯I/Oãƒã‚¦ãƒ³ãƒ‰ãªå‡¦ç†ã«ã¯æœ‰åŠ¹ã ãŒã€CPUä¸¦åˆ—ã¯multiprocessingãŒå¿…è¦
```

Rustã«ã¯**GILãŒã‚ã‚Šã¾ã›ã‚“**ã€‚tokioã®ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¯ã€è¤‡æ•°ã®CPUã‚³ã‚¢ã‚’æ´»ç”¨ã§ãã¾ã™ã€‚

```rust
// Rust: çœŸã®ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰
// tokio::spawnã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã¯ç•°ãªã‚‹CPUã‚³ã‚¢ã§å®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§
```

### ã‚ˆãã‚ã‚‹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦æ³•

**ã‚¨ãƒ©ãƒ¼1: `future cannot be sent between threads safely`**

```
error: future cannot be sent between threads safely
...the trait `Send` is not implemented for `Rc<...>`
```

åŸå› : `Rc`ãªã©`Send`ã‚’å®Ÿè£…ã—ã¦ã„ãªã„å‹ã‚’ä½¿ã£ã¦ã„ã‚‹
å¯¾å‡¦: `Arc`ã«ç½®ãæ›ãˆã‚‹

```rust
// âŒ use std::rc::Rc;
// âœ… use std::sync::Arc;
```

**ã‚¨ãƒ©ãƒ¼2: `borrowed value does not live long enough`**

```
error[E0597]: `data` does not live long enough
```

åŸå› : spawnã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ãŒå‚ç…§ã‚’æŒã£ã¦ã„ã‚‹ãŒã€å…ƒã®å¤‰æ•°ãŒå…ˆã«ç ´æ£„ã•ã‚Œã‚‹
å¯¾å‡¦: `clone()`ã¾ãŸã¯`Arc`ã§æ‰€æœ‰æ¨©ã‚’æ¸¡ã™ã€ã¾ãŸã¯`move`ã‚’ä½¿ã†

**ã‚¨ãƒ©ãƒ¼3: `async block may outlive the current function`**

åŸå› : async blockãŒé–¢æ•°ã‚ˆã‚Šé•·ãç”Ÿå­˜ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŒã€ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã‚’å€Ÿç”¨ã—ã¦ã„ã‚‹
å¯¾å‡¦: `async move`ã‚’ä½¿ã£ã¦æ‰€æœ‰æ¨©ã‚’ç§»å‹•

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

[Chapter 09: Webé–‹ç™º](09-web-development.md) ã§ã¯ã€Axumãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ã£ãŸREST APIé–‹ç™ºã‚’å­¦ã³ã¾ã™ã€‚ã“ã®ç« ã§å­¦ã‚“ã éåŒæœŸã®çŸ¥è­˜ãŒå®Ÿè·µçš„ã«æ´»ç”¨ã•ã‚Œã¾ã™ã€‚
